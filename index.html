<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>–ì—Ä–∞—Ñ—ñ–∫ –ø—Ä–∏–±–∏—Ä–∞–Ω—å</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
body { background: #f0f4f8; font-family: 'Poppins', sans-serif; }
button { transition: 0.2s; cursor: pointer; }
button:hover { transform: scale(1.05); }
input { background:#ffffffaa; color:#111; border:none; border-radius:6px; padding:6px 8px; text-align:center; transition:0.2s; }
input:disabled { background:#e5e7eb; color:#6b7280; }
tr:hover { background: rgba(0,0,0,0.05); }
.icon-btn { display:flex; align-items:center; justify-content:center; width:30px; height:30px; border-radius:50%; background:#ef4444; color:white; font-weight:bold; }
</style>
</head>
<body class="flex flex-col items-center pt-6 min-h-screen">

<!-- –õ–æ–≥—ñ–Ω -->
<div id="login-screen" class="w-full max-w-sm p-6 bg-white rounded-3xl shadow-2xl">
  <h1 class="text-2xl font-bold mb-5 text-gray-800 text-center">–í—Ö—ñ–¥ –∑–∞ –∫–≤–∞—Ä—Ç–∏—Ä–æ—é</h1>
  <input id="apt" type="number" placeholder="–ù–æ–º–µ—Ä –∫–≤–∞—Ä—Ç–∏—Ä–∏" class="w-full mb-3"/>
  <input id="pass" type="password" placeholder="–ü–∞—Ä–æ–ª—å" class="w-full mb-5"/>
  <button id="loginBtn" class="w-full py-3 bg-blue-500 rounded-3xl font-semibold text-white">–£–≤—ñ–π—Ç–∏</button>
</div>

<!-- –ì–æ–ª–æ–≤–Ω–∞ —Ç–∞–±–ª–∏—Ü—è -->
<div id="main-screen" class="hidden flex-col w-full max-w-4xl px-2 sm:px-4 lg:px-8">
  <div class="flex flex-col sm:flex-row justify-between items-center mb-3">
    <h1 class="text-2xl font-bold text-gray-800 mb-2 sm:mb-0">–ì—Ä–∞—Ñ—ñ–∫ –ø—Ä–∏–±–∏—Ä–∞–Ω—å</h1>
    <button id="logoutBtn" class="w-full sm:w-auto px-4 py-2 bg-red-500 rounded-full font-semibold text-white">–í–∏–π—Ç–∏</button>
  </div>

  <div class="flex justify-end mb-2">
    <button id="addBtn" class="w-full sm:w-auto px-4 py-2 bg-green-500 rounded-full font-semibold text-white">–î–æ–¥–∞—Ç–∏ –∑–∞–ø–∏—Å</button>
  </div>

  <div class="overflow-x-auto rounded-2xl shadow-xl">
    <table class="min-w-full table-auto text-gray-800">
      <thead class="bg-gray-200">
        <tr>
          <th class="px-2 sm:px-4 py-2 border text-center">–î–∞—Ç–∞</th>
          <th class="px-2 sm:px-4 py-2 border text-center">–ö–≤–∞—Ä—Ç–∏—Ä–∞</th>
          <th class="px-2 sm:px-4 py-2 border text-center">–¢–µ–∫—Å—Ç</th>
          <th class="px-2 sm:px-4 py-2 border text-center"></th>
        </tr>
      </thead>
      <tbody id="tbody" class="bg-white"></tbody>
    </table>
  </div>
</div>

<script>
let token = localStorage.getItem('token');
let apt = localStorage.getItem('apt');
const loginScreen = document.getElementById('login-screen');
const mainScreen = document.getElementById('main-screen');
const tbody = document.getElementById('tbody');

async function loadData() {
  const r = await fetch('/api/load');
  const data = await r.json();
  tbody.innerHTML = '';
  data.forEach((row, i) => {
    const tr = document.createElement('tr');
    const isOwner = row.author === apt;
    tr.className = i % 2 === 0 ? 'bg-white' : 'bg-gray-50';
    const date = row.date || '';
    const aptNum = row.apt || '';
    const text = row.text || '';
    tr.innerHTML = `
      <td class="border px-2 sm:px-4 py-2 text-center break-words">${date}</td>
      <td class="border px-2 sm:px-4 py-2 text-center break-words">${aptNum}</td>
      <td class="border px-2 sm:px-4 py-2 text-center break-words">
        <input type="text" class="w-full sm:w-auto p-2 rounded text-center" value="${text}" ${isOwner?'':'disabled'}>
      </td>
      <td class="border px-2 sm:px-4 py-2 flex justify-center">
        ${isOwner?'<button class="delBtn icon-btn">üóëÔ∏è</button>':''}
      </td>`;
    tbody.appendChild(tr);

    if (isOwner) {
      const input = tr.querySelector('input');
      input.addEventListener('input', async () => {
        await fetch('/api/update', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({token, index:i, text: input.value})
        });
      });

      tr.querySelector('.delBtn').onclick = async () => {
        await fetch('/api/delete', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({token, index:i})
        });
        loadData();
      };
    }
  });
}

async function doLogin(a, p){
  const r = await fetch('/api/login', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({apt:a, password:p})
  });
  const data = await r.json();
  if(data.ok){
    token = data.token;
    apt = data.apt;
    localStorage.setItem('token', token);
    localStorage.setItem('apt', apt);
    loginScreen.classList.add('hidden');
    mainScreen.classList.remove('hidden');
    loadData();
  } else alert('–ù–µ–≤—ñ—Ä–Ω–∏–π –ø–∞—Ä–æ–ª—å');
}

document.getElementById('loginBtn').onclick = () => {
  const a = document.getElementById('apt').value;
  const p = document.getElementById('pass').value;
  doLogin(a, p);
};

document.getElementById('logoutBtn').onclick = () => {
  localStorage.removeItem('token');
  localStorage.removeItem('apt');
  token = null; apt = null;
  loginScreen.classList.remove('hidden');
  mainScreen.classList.add('hidden');
};

document.getElementById('addBtn').onclick = async () => {
  if(!token) return alert('–í–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ñ!');
  await fetch('/api/add', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({token})
  });
  loadData();
};

if(token && apt){
  loginScreen.classList.add('hidden');
  mainScreen.classList.remove('hidden');
  loadData();
}
</script>
</body>
</html>
