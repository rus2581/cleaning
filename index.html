<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>Графік прибирань</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { background-color:#1e1e2f; color:#f0f0f5; font-family:sans-serif;}
button:hover { opacity:0.8; transition:0.2s; }
input { background:#2a2a40; color:#f0f0f5; border:none; border-radius:4px; padding:4px 6px;}
input:disabled { background:#1a1a2a; color:#888; }
</style>
</head>
<body class="flex items-center justify-center min-h-screen">
<div id="login-screen" class="w-96 p-6 bg-gray-800 rounded-2xl shadow-lg">
  <h1 class="text-2xl font-bold mb-4 text-center">Вхід за квартирою</h1>
  <input id="apt" type="number" placeholder="Номер квартири" class="w-full mb-2"/><br>
  <input id="pass" type="password" placeholder="Пароль" class="w-full mb-4"/><br>
  <button id="loginBtn" class="w-full py-2 bg-purple-600 rounded-2xl text-white font-semibold">Увійти</button>
</div>

<div id="main-screen" class="hidden flex-col w-11/12 max-w-4xl">
  <div class="flex justify-between items-center mb-4 mt-4">
    <h1 class="text-2xl font-bold">Графік прибирань</h1>
    <button id="addBtn" class="px-4 py-2 bg-green-600 rounded-2xl font-semibold">Додати запис</button>
  </div>
  <table class="min-w-full border-collapse">
    <thead class="bg-gray-700 text-white">
      <tr>
        <th class="px-4 py-2 border">Дата</th>
        <th class="px-4 py-2 border">Квартира</th>
        <th class="px-4 py-2 border">Текст</th>
        <th class="px-4 py-2 border">Дія</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<script>
let token=null;
let apt=null;
const loginScreen=document.getElementById('login-screen');
const mainScreen=document.getElementById('main-screen');
const tbody=document.getElementById('tbody');

async function loadData(){
  const r=await fetch('/api/load');
  const data=await r.json();
  tbody.innerHTML='';
  data.forEach((row,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="border px-2 py-1">${row.date}</td>
      <td class="border px-2 py-1">${row.apt}</td>
      <td class="border px-2 py-1">
        <input type="text" class="w-full" value="${row.text}" ${row.author===apt?'':'disabled'}>
      </td>
      <td class="border px-2 py-1 flex gap-1">
        ${row.author===apt?'<button class="updateBtn bg-blue-600 px-2 rounded text-white">Зберегти</button><button class="delBtn bg-red-600 px-2 rounded text-white">Видалити</button>':''}
      </td>`;
    tbody.appendChild(tr);

    if(row.author===apt){
      tr.querySelector('.updateBtn').onclick=async ()=>{
        const val=tr.querySelector('input').value;
        await fetch('/api/update',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token,index:i,text:val})});
        loadData();
      };
      tr.querySelector('.delBtn').onclick=async ()=>{
        await fetch('/api/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token,index:i})});
        loadData();
      };
    }
  });
}

document.getElementById('loginBtn').onclick=async ()=>{
  const a=document.getElementById('apt').value;
  const p=document.getElementById('pass').value;
  const r=await fetch('/api/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({apt:a,password:p})});
  const data=await r.json();
  if(data.ok){
    token=data.token; apt=data.apt;
    loginScreen.classList.add('hidden');
    mainScreen.classList.remove('hidden');
    loadData();
  } else alert('Невірний пароль');
};

document.getElementById('addBtn').onclick=async ()=>{
  await fetch('/api/add',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token})});
  loadData();
};
</script>
</body>
</html>
